# 内联实时编辑功能测试指南

## ✅ 插件加载成功

从日志可以看到：
- ✅ 插件已加载
- ✅ ConfigManager 初始化完成
- ✅ SettingsManager 正常工作
- ⚠️ API Key 未配置（需要先设置）

---

## 🔧 测试前准备

### 1. 配置 API Key
1. 点击 SiYuan 顶部工具栏的机器人图标
2. 或按快捷键 `Alt+Shift+C` 打开设置
3. 在设置面板中输入你的 Claude API Key
4. 点击"测试连接"确认可用

### 2. 确认快捷键
- **内联编辑**: `Ctrl+Shift+Q`
- **撤销编辑**: `Ctrl+Shift+Z`

---

## 📋 功能测试清单

### Test 1: 基本流程测试
```
✅ 步骤:
1. 在文档中输入一段文本：
   "这是一个测试文本，用于验证内联编辑功能是否正常工作。"

2. 选中这段文本

3. 按 Ctrl+Shift+Q 触发内联编辑

4. 应该看到：
   - 浮动的指令输入框出现在光标附近
   - 输入框包含：预设指令下拉菜单 + 自定义输入框

5. 输入指令（例如："改写为正式语气"）

6. 按 Enter 发送

7. 应该看到：
   ┌─────────────────────────┐
   │ [加载中] AI 思考中...    │
   └─────────────────────────┘
   然后变为：
   ┌─────────────────────────┐
   │ 原文（删除）- 红色背景   │
   │ 这是一个测试文本...     │
   ├─────────────────────────┤
   │ AI建议（新增）- 绿色背景 │
   │ [逐字显示AI返回内容]    │
   └─────────────────────────┘
   │ [✗拒绝] [↻重试] [✓接受] │
   └─────────────────────────┘

8. 点击"接受"或按 Tab

9. 验证：
   ✅ 对比块消失
   ✅ 文档中的文本已更新为AI建议
   ✅ 显示提示"✅ 修改已应用"
```

### Test 2: 快捷键测试
```
测试内容：
1. 创建内联编辑后，按 Tab → 应该接受修改
2. 创建内联编辑后，按 Esc → 应该拒绝修改
3. 创建内联编辑后，按 Ctrl+R → 应该重新生成

预期结果：所有快捷键正常响应
```

### Test 3: 预设指令测试
```
步骤：
1. 选中文本 → Ctrl+Shift+Q
2. 在下拉菜单中选择预设指令（如果有配置的话）
3. 自定义输入框应自动填充该指令
4. 按 Enter 发送

预期：预设指令可以正常使用
```

### Test 4: 流式显示测试
```
观察要点：
1. AI 返回内容是否逐字显示（打字机效果）
2. 进度提示是否显示"已接收 X 字符"
3. 动画是否流畅

预期：流式显示正常，无卡顿
```

### Test 5: 错误处理测试
```
测试场景 1: 无选中文本
- 步骤：不选中任何文本，直接按 Ctrl+Shift+Q
- 预期：提示"请先选中要编辑的文本"

测试场景 2: API 错误
- 步骤：触发编辑但 API Key 错误/网络断开
- 预期：对比块显示错误信息，可以重试

测试场景 3: 取消编辑
- 步骤：打开指令输入框后按 Esc 或点击关闭
- 预期：输入框关闭，无副作用
```

### Test 6: 撤销功能测试
```
步骤：
1. 应用一次内联编辑
2. 按 Ctrl+Shift+Z
3. 验证文本是否恢复为原文

预期：✅ 撤销成功，原文恢复
```

### Test 7: 多次编辑测试（内存泄漏检查）
```
步骤：
1. 连续触发 10 次内联编辑
2. 每次都接受或拒绝
3. 观察：
   - 页面是否变慢
   - DevTools Console 是否有错误
   - 内存使用是否异常增长

预期：无性能下降，无内存泄漏
```

### Test 8: 清理测试
```
步骤：
1. 创建 2-3 个内联编辑块（不要接受/拒绝）
2. 重新加载插件或重启 SiYuan
3. 检查控制台日志

预期：
- 看到 "[QuickEdit] Destroying QuickEditManager"
- 看到 "[QuickEdit] Cleanup complete"
- 所有对比块已移除
```

---

## 🐛 已知问题排查

### 问题 1: 对比块不出现
**可能原因**:
- API Key 未配置
- 网络连接问题
- 选中的文本不在有效的 SiYuan 块中

**解决方法**:
1. 检查 API Key 配置
2. 查看 DevTools Console 错误信息
3. 确保在文档块中选择文本

### 问题 2: 点击"接受"后文本没变化
**可能原因**:
- 块 ID 未正确获取
- SiYuan API 调用失败

**解决方法**:
1. 打开 DevTools Console
2. 查找 `[QuickEdit] Applying changes to block:` 日志
3. 检查后续是否有错误信息
4. 如果看到 "Block updated successfully"，则 API 调用成功

### 问题 3: 快捷键不响应
**可能原因**:
- 焦点不在对比块上
- 与其他插件快捷键冲突

**解决方法**:
1. 先点击对比块内部，然后按快捷键
2. 或直接点击按钮操作

---

## 📊 性能监控（可选）

### Chrome DevTools 监控
```
1. 打开 DevTools (F12)
2. 切换到 Performance 标签
3. 点击 Record
4. 执行 5-10 次内联编辑操作
5. 停止 Recording
6. 查看:
   - Memory: 应该保持平稳或小幅波动
   - Event Listeners: 不应无限增长
   - DOM Nodes: 对比块移除后节点数应恢复
```

---

## ✅ 测试结果记录

| 测试项 | 状态 | 备注 |
|--------|------|------|
| 基本流程 | ⬜ 待测试 | |
| 快捷键 | ⬜ 待测试 | |
| 预设指令 | ⬜ 待测试 | |
| 流式显示 | ⬜ 待测试 | |
| 错误处理 | ⬜ 待测试 | |
| 撤销功能 | ⬜ 待测试 | |
| 多次编辑 | ⬜ 待测试 | |
| 清理功能 | ⬜ 待测试 | |

---

## 📞 问题反馈

如果遇到问题，请提供：
1. 详细的操作步骤
2. DevTools Console 的错误日志
3. 预期行为 vs 实际行为
4. SiYuan 版本和操作系统

---

## 🎯 下一步

测试完成后，如果发现问题，我们可以：
1. 修复 bug
2. 优化性能
3. 添加更多功能（如逐行接受、i18n 等）
4. 完善文档
