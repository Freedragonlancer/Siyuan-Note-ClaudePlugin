# Quick Edit 滚动问题修复 - 测试指南

## 修复概述

修复了当用户选中文本后滚动屏幕导致预览位置错误或请求丢失的问题。

## 核心修改

### 1. ContextExtractor - API 优先策略
- ✅ 新增 `getBlockKramdownViaAPI()` - 通过 SiYuan API 获取块内容
- ✅ 新增 `getSiblingBlocksViaAPI()` - 通过 SQL API 获取兄弟块
- ✅ 改造 `getSiblingBlocks()` - 优先使用 API，DOM 作为回退

### 2. QuickEditManager - 滚动定位和重试
- ✅ 优化 `trigger()` 弹窗定位 - 使用块元素位置而非 Range
- ✅ 增强 `handleInstructionSubmit()` - 添加滚动定位和3次重试机制
- ✅ 改进错误处理 - 提供友好的错误提示

### 3. 日志和调试
- ✅ 所有关键操作都添加了详细的控制台日志
- ✅ API 调用成功/失败都有明确的日志标识

## 测试场景

### 场景 1: 基础功能（无滚动）
1. 在 SiYuan 中选中一段文本
2. 右键选择 "Quick Edit"
3. 输入指令，点击提交
4. **预期**: 预览块正常显示在选中文本下方

### 场景 2: 选中后向上滚动（核心问题）
1. 在 SiYuan 中打开一个长文档（至少50个段落）
2. 滚动到文档中间或底部，选中一段文本
3. 右键选择 "Quick Edit"，打开弹窗
4. **向上滚动** 使选中的文本移出屏幕（不可见）
5. 输入指令，点击提交
6. **预期**:
   - 自动滚动到选中的位置
   - 预览块正常显示在选中文本下方
   - 不会出现"无法定位目标块"的错误

### 场景 3: 多块选择 + 滚动
1. 在 SiYuan 中选中多个块（通过块图标拖选）
2. 右键选择 "Quick Edit"
3. 滚动使部分选中的块不可见
4. 输入指令，点击提交
5. **预期**:
   - 自动滚动到最后一个选中块的位置
   - 预览块显示在最后一个选中块的下方

### 场景 4: 使用上下文占位符（API 测试）
1. 在设置中配置一个使用 `{above_blocks=5}` 和 `{below_blocks=5}` 的预设
2. 选中文本（选中的块在屏幕外也无妨）
3. 使用该预设发起请求
4. **预期**:
   - 控制台显示 "API found X blocks" 日志
   - 上下文内容正确提取（即使块不在 DOM 中）

### 场景 5: 回退到 DOM（本地块测试）
1. 创建一个临时块（尚未保存到数据库）
2. 选中该块的文本
3. 右键选择 "Quick Edit"
4. **预期**:
   - 控制台显示 "API returned no results, falling back to DOM query"
   - 功能仍然正常工作

## 检查清单

### 功能正常性
- [ ] 选中文本后发起请求，预览位置正确
- [ ] 选中文本 → 滚动 → 发起请求，预览位置正确
- [ ] 多块选择 → 滚动 → 发起请求，预览位置正确
- [ ] 上下文占位符正确提取（API 模式）
- [ ] 弹窗位置合理（不会超出屏幕）

### 错误处理
- [ ] 块不可见时自动滚动定位
- [ ] 3次重试后仍失败时显示友好错误提示
- [ ] API 失败时能正确回退到 DOM 模式

### 日志完整性
- [ ] 控制台显示 API 尝试日志
- [ ] 控制台显示块查找成功/失败日志
- [ ] 控制台显示滚动定位日志
- [ ] 错误信息清晰可读

## 调试技巧

### 1. 开启控制台（F12）
查看所有日志输出，关键日志标签：
- `[ContextExtractor]` - 上下文提取
- `[QuickEdit]` - Quick Edit 主流程
- `✅` - 成功操作
- `⚠️` - 警告
- `❌` - 错误

### 2. 模拟虚拟滚动场景
在一个超长文档（100+ 段落）中测试，确保块会移出视口。

### 3. 检查 API 调用
在控制台 Network 标签中查看：
- `/api/query/sql` - SQL 查询
- `/api/block/getBlockKramdown` - 块内容获取

## 已知限制

1. **滚动动画**: 使用 `scrollIntoView({ behavior: 'smooth' })`，可能在某些浏览器中不支持
2. **重试延迟**: 3次重试总计约800ms延迟，用户可能感觉稍慢
3. **API 依赖**: 需要 SiYuan 内核支持 SQL API 和 getBlockKramdown API

## 回滚方案

如果修复导致新问题，可以回滚到以下 commit：
```bash
git log --oneline | head -1  # 查看当前 commit
git revert <commit-hash>     # 回滚到修复前
```

## 性能影响

- **API 调用**: 每次上下文提取增加 1-2 个 API 请求（约50-100ms）
- **滚动定位**: 最多增加 800ms 延迟（3次重试）
- **内存占用**: 无明显增加

## 反馈渠道

如果遇到问题，请提供：
1. 控制台完整日志（F12 → Console）
2. 操作步骤详细描述
3. SiYuan 版本号
4. 浏览器版本

---

**测试完成时间**: _________
**测试人员**: _________
**测试结果**: ✅ 通过 / ⚠️ 部分通过 / ❌ 失败
**备注**: _________
